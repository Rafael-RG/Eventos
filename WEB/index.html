<script>
    // Función para descargar el archivo automáticamente o mostrar un mensaje si el evento no está disponible
    function downloadFile() {
        // Obtener el valor del parámetro 'event' de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const eventParam = urlParams.get('event');

        if (!eventParam) {
            console.error('El parámetro "event" no está presente en la URL.');
            return;
        }

        // Construir la URL con el parámetro 'event' para obtener el archivo .ics
        const fetchUrl = `https://recuerdame.azurewebsites.net/api/event?event=${eventParam}&code=Qjgv-L55Jc88E6FkBX73MhThSXtZJZLguUj2YtsW0Wb0AzFuoV2pug%3D%3D`;

        fetch(fetchUrl, {
                method: 'GET'
            })
            .then(response => {
                if (response.status === 204) {
                    // Mostrar un pop-up indicando que el evento ya no está disponible
                    alert('El evento ya no está disponible.');
                    window.close();
                    return;
                }

                // Si la respuesta no es 204, continuar con la descarga
                return response.json();
            })
            .then(data => {
                if (!data) return; // Si no hay datos (ya se mostró el mensaje), detener la ejecución

                const fileContents = atob(data.fileContents);
                const contentType = data.contentType;
                const fileDownloadName = data.fileDownloadName;

                // Crear un Uint8Array a partir del contenido del archivo
                const byteArray = new Uint8Array(fileContents.length);
                for (let i = 0; i < fileContents.length; i++) {
                    byteArray[i] = fileContents.charCodeAt(i);
                }

                // Crear un blob con el contenido del archivo
                const blob = new Blob([byteArray], { type: contentType });

                // Crear un enlace temporal para descargar el archivo
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = fileDownloadName;

                // Añadir el enlace al cuerpo del documento y hacer clic en él para descargar el archivo
                document.body.appendChild(link);
                link.click();

                // Eliminar el enlace del documento
                document.body.removeChild(link);

                // Esperar a que el navegador complete la descarga antes de cerrar la ventana
                link.addEventListener('click', () => {
                    window.URL.revokeObjectURL(link.href); // Limpiar la URL creada
                    setTimeout(() => {
                        window.close(); // Cerrar la ventana después de la descarga
                    }, 9000); // Tiempo suficiente para que la descarga comience
                });
            })
            .catch(error => {
                console.error('Error al descargar el archivo:', error);
            });
    }

    // Ejecutar la función cuando la página se cargue
    window.onload = downloadFile;
</script>
